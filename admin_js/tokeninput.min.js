(function(c){var Q={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch]+"</li>"},tokenFormatter:function(g){return"<li><p>"+
g[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},H={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},I={init:function(g,
p){var a=c.extend({},Q,p||{});return this.each(function(){c(this).data("tokenInputObject",new c.TokenList(this,g,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()}};c.fn.tokenInput=function(g){return I[g]?I[g].apply(this,Array.prototype.slice.call(arguments,1)):I.init.apply(this,
arguments)};c.TokenList=function(g,p,a){function A(){null!==a.tokenLimit&&u>=a.tokenLimit&&(h.hide(),v())}function y(b){var d=a.tokenFormatter(b);d=c(d).addClass(a.classes.token).insertBefore(w);c("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(d).click(function(){E(c(this).parent());n.change();return!1});var f={id:b.id};f[a.propertyToSearch]=b[a.propertyToSearch];c.data(d.get(0),"tokeninput",b);q=q.slice(0,r).concat([f]).concat(q.slice(r));r++;N(q,n);u+=1;null!==a.tokenLimit&&
u>=a.tokenLimit&&(h.hide(),v());return d}function B(b){var d=a.onAdd;!b&&0<h.val().length&&(b={id:h.val()},b[a.propertyToSearch]=h.val());if(!b)return!1;if(0<u&&a.preventDuplicates){var f=null;x.children().each(function(){var e=c(this),m=c.data(e.get(0),"tokeninput");if(m&&m.id===b.id)return f=e,!1});if(f){D(f);w.insertAfter(f);h.focus();return}}if(null==a.tokenLimit||u<a.tokenLimit)y(b),A();h.val("");v();c.isFunction(d)&&d.call(n,b)}function D(b){b.addClass(a.classes.selectedToken);l=b.get(0);h.val("");
v()}function C(b,d){b.removeClass(a.classes.selectedToken);l=null;0===d?(w.insertBefore(b),r--):1===d?(w.insertAfter(b),r++):(w.appendTo(x),r=u);h.focus()}function E(b){var d=c.data(b.get(0),"tokeninput"),f=a.onDelete,e=b.prevAll().length;e>r&&e--;b.remove();l=null;h.focus();q=q.slice(0,e).concat(q.slice(e+1));e<r&&r--;N(q,n);--u;null!==a.tokenLimit&&h.show().val("").focus();c.isFunction(f)&&f.call(n,d)}function N(b,d){b=c.map(b,function(f){return f[a.tokenValue]});d.val(b.join(a.tokenDelimiter))}
function v(){z.hide().empty();t=null}function F(){z.css({position:"absolute",top:c(x).offset().top+c(x).outerHeight(),left:c(x).offset().left,zindex:999}).show()}function J(b,d){if(d&&d.length){z.empty();var f=c("<ul>").appendTo(z).mouseover(function(e){K(c(e.target).closest("li"))}).mousedown(function(e){B(c(e.target).closest("li").data("tokeninput"));n.change();return!1}).hide();c.each(d,function(e,m){var k=a.resultsFormatter(m),G=m[a.propertyToSearch];k=k.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+
G+")(?![^<>]*>)(?![^&;]+;)","g"),G.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"));k=c(k).appendTo(f);e%2?k.addClass(a.classes.dropdownItem):k.addClass(a.classes.dropdownItem2);0===e&&K(k);c.data(k.get(0),"tokeninput",m)});F();a.animateDropdown?f.slideDown("fast"):f.show()}else a.noResultsText&&(z.html("<p>"+a.noResultsText+"</p>"),F())}function K(b){b&&(t&&(c(t).removeClass(a.classes.selectedDropdownItem),t=null),b.addClass(a.classes.selectedDropdownItem),
t=b.get(0))}function O(){var b=h.val(),d=b.toLowerCase();d&&d.length&&(l&&C(c(l),1),d.length>=a.minChars?(a.searchingText&&(z.html("<p>"+a.searchingText+"</p>"),F()),clearTimeout(P),P=setTimeout(function(){R(d,b)},a.searchDelay)):v())}function R(b,d){var f=d+L(),e=M.get(f);if(e)J(b,e);else if(a.url){e=L();var m={data:{}};-1<e.indexOf("?")?(e=e.split("?"),m.url=e[0],e=e[1].split("&"),c.each(e,function(k,G){k=G.split("=");m.data[k[0]]=k[1]})):m.url=e;m.data[a.queryParam]=b;m.type=a.method;m.dataType=
a.contentType;a.crossDomain&&(m.dataType="jsonp");m.success=function(k){c.isFunction(a.onResult)&&(k=a.onResult.call(n,k,b,d));M.add(f,a.jsonContainer?k[a.jsonContainer]:k);h.val().toLowerCase()===b&&J(b,a.jsonContainer?k[a.jsonContainer]:k)};c.ajax(m)}else a.local_data&&(e=c.grep(a.local_data,function(k){return-1<k[a.propertyToSearch].toLowerCase().indexOf(b.toLowerCase())}),c.isFunction(a.onResult)&&(e=a.onResult.call(n,e,b,d)),M.add(f,e),J(b,e))}function L(){var b=a.url;"function"==typeof a.url&&
(b=a.url.call());return b}"string"===c.type(p)||"function"===c.type(p)?(a.url=p,p=L(),void 0===a.crossDomain&&(-1===p.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==p.split(/\/+/g)[1])):"object"===typeof p&&(a.local_data=p);a.classes?a.classes=c.extend({},H,a.classes):a.theme?(a.classes={},c.each(H,function(b,d){a.classes[b]=d+"-"+a.theme})):a.classes=H;var q=[],u=0,M=new c.TokenList.Cache,P,h=c('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",
a.idPrefix+g.id).focus(function(){null!==a.tokenLimit&&a.tokenLimit===u||!a.hintText||(z.html("<p>"+a.hintText+"</p>"),F())}).blur(function(){v();c(this).val("")}).keydown(function(b){switch(b.keyCode){case 37:case 39:case 38:case 40:if(c(this).val()){var d=null;d=40===b.keyCode||39===b.keyCode?c(t).next():c(t).prev();d.length&&K(d);return!1}d=w.prev();var f=w.next();d.length&&d.get(0)===l||f.length&&f.get(0)===l?37===b.keyCode||38===b.keyCode?C(c(l),0):C(c(l),1):37!==b.keyCode&&38!==b.keyCode||!d.length?
39!==b.keyCode&&40!==b.keyCode||!f.length||D(c(f.get(0))):D(c(d.get(0)));break;case 8:d=w.prev();if(c(this).val().length)1===c(this).val().length?v():setTimeout(function(){O()},5);else return l?(E(c(l)),n.change()):d.length&&D(c(d.get(0))),!1;break;case 13:case 108:case 188:return t?(B(c(t).data("tokeninput")),n.change()):B(null),!1;case 27:return v(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){O()},5)}}),n=c(g).hide().val("").focus(function(){h.focus()}).blur(function(){h.blur()}),
l=null,r=0,t=null,x=c("<ul />").addClass(a.classes.tokenList).click(function(b){if((b=c(b.target).closest("li"))&&b.get(0)&&c.data(b.get(0),"tokeninput")){var d=l;l&&C(c(l),2);d===b.get(0)?C(b,2):D(b)}else l&&C(c(l),2),h.focus()}).mouseover(function(b){(b=c(b.target).closest("li"))&&l!==this&&b.addClass(a.classes.highlightedToken)}).mouseout(function(b){(b=c(b.target).closest("li"))&&l!==this&&b.removeClass(a.classes.highlightedToken)}).insertBefore(n),w=c("<li />").addClass(a.classes.inputToken).appendTo(x).append(h),
z=c("<div>").addClass(a.classes.dropdown).appendTo("body").hide();c("<tester/>").insertAfter(h).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:h.css("fontSize"),fontFamily:h.css("fontFamily"),fontWeight:h.css("fontWeight"),letterSpacing:h.css("letterSpacing"),whiteSpace:"nowrap"});n.val("");g=a.prePopulate||n.data("pre");a.processPrePopulate&&c.isFunction(a.onResult)&&(g=a.onResult.call(n,g));g&&g.length&&c.each(g,function(b,d){y(d);A()});c.isFunction(a.onReady)&&a.onReady.call();
this.clear=function(){x.children("li").each(function(){0===c(this).children("input").length&&E(c(this))})};this.add=function(b){B(b)};this.remove=function(b){x.children("li").each(function(){if(0===c(this).children("input").length){var d=c(this).data("tokeninput"),f=!0,e;for(e in b)if(b[e]!==d[e]){f=!1;break}f&&E(c(this))}})};this.getTokens=function(){return q}};c.TokenList.Cache=function(g){var p=c.extend({max_size:500},g),a={},A=0;this.add=function(y,B){A>p.max_size&&(a={},A=0);a[y]||(A+=1);a[y]=
B};this.get=function(y){return a[y]}}})(jQuery);
